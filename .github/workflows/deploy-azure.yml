name: Deploy FlysSeats to Azure

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.9'

jobs:
  # ============================================
  # JOB 1: Deploy Infrastructure with Terraform
  # ============================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    # Solo en push a main
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        working-directory: ./infrastructure/terraform
        run: terraform init
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Terraform Validate
        working-directory: ./infrastructure/terraform
        run: terraform validate
      
      - name: Terraform Plan
        working-directory: ./infrastructure/terraform
        run: |
          terraform plan \
            -var="environment=prod" \
            -var="location=westeurope" \
            -out=tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Terraform Apply
        working-directory: ./infrastructure/terraform
        run: terraform apply -auto-approve tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ============================================
  # JOB 2: Build and Test Backend
  # ============================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Create and activate virtual environment
        working-directory: ./backend
        run: |
          python -m venv venv
          source venv/bin/activate
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Opcional: Run tests
      # - name: Run tests
      #   working-directory: ./backend
      #   run: |
      #     pip install pytest
      #     pytest tests/
      
      - name: Upload backend artifact
        uses: actions/upload-artifact@v3
        with:
          name: backend
          path: ./backend

  # ============================================
  # JOB 3: Build and Test Frontend
  # ============================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './flyseats-frontend/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./flyseats-frontend
        run: npm ci
      
      - name: Lint
        working-directory: ./flyseats-frontend
        run: npm run lint -- --max-warnings=0
        continue-on-error: true
      
      # Opcional: Run tests
      # - name: Run unit tests
      #   working-directory: ./flyseats-frontend
      #   run: npm run test:ci
      
      - name: Build production
        working-directory: ./flyseats-frontend
        run: npm run build -- --configuration=production
      
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v3
        with:
          name: frontend
          path: ./flyseats-frontend/dist

  # ============================================
  # JOB 4: Deploy Backend to Azure Functions
  # ============================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [build-backend, deploy-infrastructure]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v3
        with:
          name: backend
          path: ./backend
      
      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: './backend'
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          respect-funcignore: true
      
      - name: Verify deployment
        run: |
          echo "Backend deployed successfully!"
          echo "URL: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net"

  # ============================================
  # JOB 5: Deploy Frontend to Azure Web App
  # ============================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [build-frontend, deploy-infrastructure]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v3
        with:
          name: frontend
          path: ./dist
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Azure Web App
        uses: Azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: './dist'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
      
      - name: Verify deployment
        run: |
          echo "Frontend deployed successfully!"
          echo "URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"

  # ============================================
  # JOB 6: Post-Deployment Configuration
  # ============================================
  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Configure CORS
        run: |
          az functionapp cors remove \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --allowed-origins "*" || true
          
          az functionapp cors add \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --allowed-origins "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
      
      - name: Warm up endpoints
        run: |
          echo "Warming up backend..."
          curl -f https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health || true
          
          echo "Warming up frontend..."
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net || true
      
      - name: Send deployment notification
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Deployment completed successfully!\n\n' +
                    'üåê Frontend: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net\n' +
                    '‚ö° Backend: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net'
            })

  # ============================================
  # JOB 7: Smoke Tests
  # ============================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [post-deployment]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Test Frontend
        run: |
          echo "Testing frontend availability..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Frontend is accessible"
          else
            echo "‚ùå Frontend returned $response"
            exit 1
          fi
      
      - name: Test Backend Health
        run: |
          echo "Testing backend health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health)
          if [ $response -eq 200 ] || [ $response -eq 404 ]; then
            echo "‚úÖ Backend is accessible"
          else
            echo "‚ùå Backend returned $response"
            exit 1
          fi
      
      - name: Test API Endpoint
        run: |
          echo "Testing flights search endpoint..."
          curl -X POST https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/flights \
            -H "Content-Type: application/json" \
            -d '{"origin":"MAD","destination":"BCN","departureDate":"2026-03-15","adults":1}' \
            --fail-with-body || echo "‚ö†Ô∏è  Flights endpoint test failed (might be expected)"
